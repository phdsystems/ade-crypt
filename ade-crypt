#!/bin/bash
# ADE crypt - Main Executable
# This is the user-facing script for the Agentic Development Environment

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# If we're in bin/, go up one level. Otherwise we're in the root
if [[ "$SCRIPT_DIR" == */bin ]]; then
    BASE_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
else
    BASE_DIR="$SCRIPT_DIR"
fi

# Set up paths
export SRC_DIR="$BASE_DIR/src"
export MODULES_DIR="$SRC_DIR/modules"
export LIB_DIR="$SRC_DIR/lib"
export CORE_DIR="$SRC_DIR/core"

# Source core components
source "$CORE_DIR/dispatcher.sh"
source "$CORE_DIR/help.sh"

# Initialize
init_directories
load_config

# Main execution
main() {
    # Check modules on first run
    check_modules
    
    # Parse command
    local command="${1:-help}"
    
    case "$command" in
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            show_version
            ;;
        encrypt|decrypt|secrets|keys|export|import|backup|sync)
            # Module command
            dispatch_module "$@"
            ;;
        store|get|list|generate-key|rotate-keys|restore)
            # Legacy command
            handle_legacy_command "$@"
            ;;
        *)
            # Try as legacy command first
            if ! handle_legacy_command "$@"; then
                error_exit "Unknown command: $command (try 'help')"
            fi
            ;;
    esac
}

# Run main
main "$@"